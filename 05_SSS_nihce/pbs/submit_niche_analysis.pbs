#!/bin/bash
#PBS -l nodes=1:ppn=10,mem=100gb
#PBS -N Niche_Analysis
#PBS -M yh_599@163.com
#PBS -m ea
#PBS -o /dellstorage09/quj_lab/yanghang/spatial/logs/
#PBS -e /dellstorage09/quj_lab/yanghang/spatial/logs/

source /data/home/quj_lab/yanghang/miniconda3/etc/profile.d/conda.sh
conda activate r-env

WORK_DIR="/data/home/quj_lab/yanghang/A-spatial-transcriptome-landscape-of-mouse-aging/05_SSS_nihce"
GENE_LIST_DIR="/dellstorage09/quj_lab/yanghang/spatial/ref"
OUTPUT_DIR="/dellstorage09/quj_lab/yanghang/spatial/output"
SEURAT_DIR="/dellstorage01/quj_lab/zhangbin/published_project/mouse_spatial_transcriptome_2024/stereo_seq_data/seurat_rds"

cd "$WORK_DIR"

GENE_LIST_FILE=$(ls "$GENE_LIST_DIR"/*.txt | sed -n "${PBS_ARRAYID}p")

# 打印用以调试的输出
echo "PBS_ARRAYID: ${PBS_ARRAYID}"
echo "Gene list path: ${GENE_LIST_FILE}"

if [[ -z "$GENE_LIST_FILE" ]]; then
    echo "No gene list for array ID ${PBS_ARRAYID}"
    exit 1
fi

GENE_LIST_NAME=$(basename "$GENE_LIST_FILE" .txt)

echo "Processing gene list: $GENE_LIST_NAME"
echo "File: $GENE_LIST_FILE"

# 启动 R 脚本
Rscript - <<EOF
source("00_config.R")  # 加载配置文件

CONFIG\$work_dir <- "$WORK_DIR"
CONFIG\$seurat_dir <- "$SEURAT_DIR"
CONFIG\$output_base_dir <- file.path("$OUTPUT_DIR", "$GENE_LIST_NAME")
CONFIG\$gene_list_path <- "$GENE_LIST_FILE"  # 这里应该确认是有效路径
CONFIG\$batch_mode <- TRUE
CONFIG\$n_workers <- 10

# 打印配置以用于调试
cat("CONFIG settings:\n")
cat(sprintf("  work_dir: %s\n", CONFIG\$work_dir))
cat(sprintf("  seurat_dir: %s\n", CONFIG\$seurat_dir))
cat(sprintf("  output_base_dir: %s\n", CONFIG\$output_base_dir))
cat(sprintf("  gene_list_path: %s\n", CONFIG\$gene_list_path))

# 检查是否正确传递了文件路径
cat("DEBUG: Checking the gene_list_path validity...\n")
if (!nzchar(CONFIG\$gene_list_path)) {
    stop("❌ gene_list_path is empty or not valid.")
}

# 检查文件是否存在
if (!file.exists(CONFIG\$gene_list_path)) {
    stop(sprintf("❌ 基因列表文件不存在: %s", CONFIG\$gene_list_path))
} else {
    cat("✅ 基因列表文件已找到\n")
}

# 运行主批处理流程
source("main.R")
main_batch()
EOF

echo "Finished: $GENE_LIST_NAME"